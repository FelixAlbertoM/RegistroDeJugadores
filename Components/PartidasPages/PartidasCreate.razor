@page "/Partidas/Create/"
@inject PartidasService partidasService
@inject JugadoresService jugadoresService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Crear Partida</PageTitle>

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-white text-center">
            <h5 class="mb-0">Crear Partida</h5>
        </div>
        <div class="card-body">
            <EditForm Model="Partida" OnValidSubmit="GuardarPartida">
                <DataAnnotationsValidator/>
                <ValidationSummary/>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Jugador 1</label>
                        @if (ListaJugadores.Any())
                        {
                            <InputSelect class="form-select" @bind-Value="Partida.Jugador1Id">
                                <option value="0">-- Seleccione Jugador 1 --</option>
                                @foreach (var jugador in ListaJugadores)
                                {
                                    <option value="@jugador.JugadorId">@jugador.Nombres</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Partida.Jugador1Id)" />
                        }
                        else
                        {
                            <p class="text-warning">No hay jugadores para seleccionar.</p>
                        }
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Jugador 2</label>
                        @if (ListaJugadores.Any())
                        {
                            <InputSelect class="form-select" @bind-Value="Partida.Jugador2Id">
                                <option value="0">Seleccione un Jugador</option>
                                @foreach (var jugador in ListaJugadores.Where(j => j.JugadorId != Partida.Jugador1Id || Partida.Jugador1Id == 0))
                                {
                                    <option value="@jugador.JugadorId">@jugador.Nombres</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Partida.Jugador2Id)" />
                        }
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold" >Hora de inicio</label>
                    <input type="datetime-local" class="form-control" @bind="Partida.FechaInicio" />
                </div>


                <div class="mb-3">
                    <label class="form-label fw-bold">Estado de la Partida</label>
                    <InputSelect class="form-control form-select" @bind-Value="Partida.EstadoPartida">
                        <option value="" disabled>Seleccione estado</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Juego">En Juego</option>
                        <option value="Finalizada">Finalizada</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => Partida.EstadoPartida)" />
                </div>
                
                <div class="card-footer text-center">
                    <button type="submit" class="btn btn-success">
                        <i class ="bi bi-save"></i> Guardar
                    </button>
                    <a href="/Partidas/index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left-circle"></i> Cancelar
                    </a>
                </div>
            </EditForm>
            @if (!string.IsNullOrEmpty(Mensaje))
            {
                <div class="alert alert-warning mt-2">@Mensaje</div>
            }
        </div>
    </div>
</div> 

@code
{
    private Partidas Partida { get; set; } = new();
    private List<Jugadores> ListaJugadores { get; set; } = new();
    private string Mensaje { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        ListaJugadores = await jugadoresService.Listar(j => true) ?? new List<Jugadores>();
        if (!ListaJugadores.Any())
        {
            Mensaje = "No hay jugadores disponibles. Crea al menos un jugador primero.";
        }
    }

    private async Task GuardarPartida()
    {
        if (Partida.Jugador1Id==0 || Partida.Jugador2Id==0)
        {
            Mensaje = "Debe seleccionar ambos jugadores.";
            return;
        }
        if (Partida.Jugador1Id == Partida.Jugador2Id)
        {
            Mensaje = "Jugador 1 y Jugador 2 no pueden ser los mismos.";
            return;
        }
        if (await partidasService.Guardar(Partida))
        {
            NavigationManager.NavigateTo("/Victorias/index"); 
        }
        else
        {
            Mensaje = " No se puede guardar la partida.";
        }
    }
}
